<script>
const SUPABASE_URL = "https://aesmaafngzsztroqycto.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  }
);

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const message = document.getElementById("message");

/* ============================
   AUTO REDIRECT IF LOGGED IN
============================ */
window.addEventListener("DOMContentLoaded", async () => {
  const { data } = await supabase.auth.getSession();
  if (data.session) {
    await redirectByRole(data.session.user.id);
  }
});

/* ============================
   LOGIN HANDLER
============================ */
loginBtn.addEventListener("click", async () => {
  message.innerHTML = "";
  loginBtn.disabled = true;
  loginBtn.innerText = "جاري الدخول...";

  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();

  if (!email || !password) {
    showError("الرجاء إدخال البريد وكلمة المرور");
    return;
  }

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  });

  if (error || !data.session) {
    showError("بيانات الدخول غير صحيحة");
    return;
  }

  await redirectByRole(data.user.id);
});

/* ============================
   ROLE RESOLUTION
============================ */
async function redirectByRole(userId) {
  const { data: roleData, error } = await supabase
    .from("user_roles")
    .select("role")
    .eq("user_id", userId)
    .single();

  if (error || !roleData) {
    await supabase.auth.signOut();
    showError("لم يتم العثور على دور المستخدم");
    return;
  }

  if (roleData.role === "admin") {
    window.location.href = "dashboard.html";
  } else if (roleData.role === "merchant") {
    window.location.href = "orders.html";
  } else {
    await supabase.auth.signOut();
    showError("دور غير معروف");
  }
}

/* ============================
   ERROR UI HANDLER
============================ */
function showError(text) {
  message.innerHTML = text;
  loginBtn.disabled = false;
  loginBtn.innerText = "دخول";
}
</script>
