<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¯ÙØ¹</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      direction: rtl;
      text-align: center;
    }
    .box {
      max-width: 500px;
      margin: auto;
      padding: 20px;
      border-radius: 10px;
      background: #f5f5f5;
    }
  </style>
</head>
<body>

  <div class="box">
    <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹â€¦</h2>
    <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø§Øª.</p>
  </div>

  <script>
    // Ù‚Ø±Ø§Ø¡Ø© checkoutId Ùˆ mode Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const checkoutId = urlParams.get("id");
    const mode = urlParams.get("mode");

    // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª HyperPay Ù…Ù† localStorage
    const settings = JSON.parse(localStorage.getItem("paymentSettings"));

    if (!settings || !settings.entityId || !settings.accessToken) {
      document.body.innerHTML = "<h2>Ø®Ø·Ø£: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª HyperPay ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©</h2>";
      throw new Error("Missing HyperPay settings");
    }

    const entityId = settings.entityId;
    const token = settings.accessToken;

    // Ø±Ø§Ø¨Ø· API Ø­Ø³Ø¨ ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„
    const url =
      mode === "test"
        ? `https://eu-test.oppwa.com/v1/checkouts/${checkoutId}/payment?entityId=${entityId}`
        : `https://eu-prod.oppwa.com/v1/checkouts/${checkoutId}/payment?entityId=${entityId}`;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹
    fetch(url, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
      .then(res => res.json())
      .then(data => {
        console.log("Payment Result:", data);

        const resultCode = data.result.code;

        // Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ HyperPay ØªØ¨Ø¯Ø£ Ø¨Ù€ 000.
if (resultCode.startsWith("000")) {
  document.body.innerHTML = `
    <div class="box">
      <h2 style="color:green;">ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­</h2>
      <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹.</p>
      <button onclick="goBack()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</button>
    </div>
  `;

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ Ø¯Ø§Ø®Ù„ Ù…Ù†ØµØªÙƒ
  const links = JSON.parse(localStorage.getItem("paymentLinks")) || [];
  const link = links.find(l => l.checkoutId === checkoutId);

  if (link) {
    link.status = "paid";
    link.paidAt = new Date().toISOString();
    localStorage.setItem("paymentLinks", JSON.stringify(links));
  }

  // ğŸ”¥ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§
  const pending = JSON.parse(localStorage.getItem("pendingOrderData"));

  // ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  const orderId = createOrder({
    merchantId: pending.merchantId,
    items: pending.items,
    subtotal: pending.subtotal,
    discount: pending.discount,
    total: pending.total,
    coupon: pending.coupon,
    paymentMethod: "online"
  });

  // ğŸ”¥ Ø±Ø¨Ø· Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹
  link.orderId = orderId;
  localStorage.setItem("paymentLinks", JSON.stringify(links));

  // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
  localStorage.removeItem("pendingOrderData");

} else {
  document.body.innerHTML = `
    <div class="box">
      <h2 style="color:red;">ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹</h2>
      <p>Ù„Ù„Ø£Ø³Ù Ù„Ù… ØªØªÙ… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹.</p>
      <button onclick="goBack()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</button>
    </div>
  `;
}
      })
      .catch(err => {
        console.error(err);
        document.body.innerHTML = "<h2>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹</h2>";
      });

    function goBack() {
      window.location.href = "index.html";
    }
  </script>

</body>
</html>